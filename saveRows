import mysql from 'mysql2/promise';
import dotenv from 'dotenv';

dotenv.config();

export default async function handler(req, res) {
  // Connect to your external MySQL database using env variables
  const connection = await mysql.createConnection({
    host: process.env.DB_HOST,
    user: process.env.DB_USER,
    password: process.env.DB_PASSWORD,
    database: process.env.DB_NAME
  });

  try {
    if (req.method === 'POST') {
      // ADD: Add a new row
      const { name, amount } = req.body;
      if (!name || !amount) return res.status(400).send('Missing data');
      await connection.query('INSERT INTO form_rows (name, amount) VALUES (?, ?)', [name, amount]);
      return res.json({ success: true, action: 'add' });
    }

    if (req.method === 'PUT') {
      // EDIT: Update an existing row
      const { id, name, amount } = req.body;
      if (!id || !name || !amount) return res.status(400).send('Missing data');
      await connection.query('UPDATE form_rows SET name = ?, amount = ? WHERE id = ?', [name, amount, id]);
      return res.json({ success: true, action: 'edit' });
    }

    if (req.method === 'DELETE') {
      // DELETE: Delete a row
      const { id } = req.body;
      if (!id) return res.status(400).send('Missing id');
      await connection.query('DELETE FROM form_rows WHERE id = ?', [id]);
      return res.json({ success: true, action: 'delete' });
    }

    return res.status(405).end();
  } finally {
    await connection.end();
  }
}
